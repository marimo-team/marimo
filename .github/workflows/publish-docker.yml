name: Publish Docker images

on:
  workflow_call:
    inputs:
      marimo_version:
        description: 'marimo version to publish'
        required: true
        type: string
  workflow_dispatch:
    inputs:
      marimo_version:
        description: 'marimo version to publish'
        required: true
        type: string

permissions:
  contents: read
  packages: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: marimo-team/marimo

jobs:
  publish_docker:
    name: üêã Publish Docker images
    runs-on: ubuntu-latest
    # Don't error while this is in BETA
    continue-on-error: true

    steps:
      - name: ‚¨áÔ∏è Checkout repo
        uses: actions/checkout@v4

      - name: ‚è≥ Wait for PyPI package availability
        run: |
          VERSION="${{ inputs.marimo_version }}"
          echo "Waiting for marimo version $VERSION to be available on PyPI..."

          MAX_ATTEMPTS=30
          ATTEMPT=0
          SLEEP_TIME=10

          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))
            echo "Attempt $ATTEMPT/$MAX_ATTEMPTS: Checking PyPI for version $VERSION..."

            # Check if the version exists on PyPI
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "https://pypi.org/pypi/marimo/$VERSION/json")

            if [ "$HTTP_CODE" = "200" ]; then
              echo "‚úÖ Version $VERSION is available on PyPI!"
              exit 0
            else
              echo "Version $VERSION not yet available (HTTP $HTTP_CODE). Waiting ${SLEEP_TIME}s..."
              sleep $SLEEP_TIME
            fi
          done

          echo "‚ùå Timed out waiting for version $VERSION on PyPI after $((MAX_ATTEMPTS * SLEEP_TIME)) seconds"
          exit 1

      - name: üêã Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: üêã Extract metadata (tags, labels) for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}

      - name: üêã Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: üß™ Build docker image for testing
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./docker/Dockerfile
          # Don't push test image
          push: false
          load: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:test
          target: slim
          build-args: |
            marimo_version=${{ inputs.marimo_version }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: üß™ Test docker build
        run: |
          docker run -d -e PORT=9090 -p 9090:9090 --name test_container ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:test

          # Wait for container to be ready with retries
          echo "Waiting for marimo server to start..."
          MAX_ATTEMPTS=30
          ATTEMPT=0
          SLEEP_TIME=2

          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))
            echo "Attempt $ATTEMPT/$MAX_ATTEMPTS: Checking health endpoint..."

            if curl -f http://localhost:9090/health 2>/dev/null; then
              echo "‚úÖ Health check passed!"
              docker stop test_container
              docker rm test_container
              exit 0
            else
              echo "Health check failed. Waiting ${SLEEP_TIME}s..."
              sleep $SLEEP_TIME
            fi
          done

          echo "‚ùå Health check failed after $((MAX_ATTEMPTS * SLEEP_TIME)) seconds"
          echo "Container logs:"
          docker logs test_container
          docker stop test_container
          docker rm test_container
          exit 1

      - name: üì¶ Build and push Docker images (slim)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./docker/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ inputs.marimo_version }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          target: slim
          platforms: linux/amd64,linux/arm64
          build-args: |
            marimo_version=${{ inputs.marimo_version }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: üì¶ Build and push Docker images (data)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./docker/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ inputs.marimo_version }}-data
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest-data
          target: data
          platforms: linux/amd64,linux/arm64
          build-args: |
            marimo_version=${{ inputs.marimo_version }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: üì¶ Build and push Docker images (sql)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./docker/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ inputs.marimo_version }}-sql
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest-sql
          target: sql
          platforms: linux/amd64,linux/arm64
          build-args: |
            marimo_version=${{ inputs.marimo_version }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
