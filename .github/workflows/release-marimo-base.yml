name: Publish marimo-base release

# release a new version of marimo-base on tag push
on:
  push:
    tags:
      - '[0-9]+.[0-9]+.[0-9]+'
  workflow_dispatch: {}

env:
  TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
  TURBO_TEAM: marimo
  REGISTRY: ghcr.io
  IMAGE_NAME: marimo-team/marimo

jobs:
  publish_release:
    name: ðŸ“¤ Publish release
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash

    outputs:
      marimo_version: ${{ steps.get_version.outputs.marimo_version }}

    steps:
      - name: ðŸ›‘ Cancel Previous Runs
        uses: styfle/cancel-workflow-action@0.12.1

      - name: â¬‡ï¸ Checkout repo
        uses: actions/checkout@v4

      - name: ðŸ¥š Install Hatch
        uses: pypa/hatch@install

      # Python build tools generally only allow building one project
      # per Python project. This modifies the pyproject.toml
      # to build marimo-base, a slimmed down marimo distribution with
      # no static artifacts.
      # 
      # Adapted from https://github.com/cvxpy/cvxpy/blob/297278e2a88db3c0084750052a16e60672074da3/.github/workflows/build.yml#L169C1-L180C1
      - name: Adapt pyproject.toml to build marimo-base
        run: |
          # Mac has a different syntax for sed -i, this works across oses
          sed -i.bak -e 's/name = "marimo"/name = "marimo-base"/g' pyproject.toml
          # Remove static artifacts
          sed -i.bak '/artifacts = /d' pyproject.toml
          rm -rf pyproject.toml.bak

      - name: ðŸ“¦ Build marimo-base
        run: hatch build

      - name: ðŸ“¤ Upload to PyPI
        env:
          HATCH_INDEX_USER: ${{ secrets.PYPI_USER }}
          HATCH_INDEX_AUTH: ${{ secrets.PYPI_MARIMO_BASE_PASSWORD }}
        run: hatch publish

      - name: ðŸ”¨ Get version
        id: get_version
        run: |
          echo "marimo_version=$(hatch version)" >> $GITHUB_OUTPUT
