name: Publish prod release

on:
  workflow_call: {}

permissions:
  contents: read

env:
  TURBO_TEAM: marimo
  REGISTRY: ghcr.io
  IMAGE_NAME: marimo-team/marimo

jobs:
  publish_release:
    name: ğŸ“¤ Publish release
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash

    outputs:
      marimo_version: ${{ steps.get_version.outputs.marimo_version }}

    steps:
      - name: â¬‡ï¸ Checkout repo
        uses: actions/checkout@v4

      - name: ğŸ“¦ Build frontend
        uses: ./.github/actions/build-frontend
        with:
          turbo-token: ${{ secrets.TURBO_TOKEN }}
          codecov-token: ${{ secrets.CODECOV_TOKEN }}

      - name: ğŸ¥š Install Hatch
        uses: pypa/hatch@install

      - name: ğŸ“¦ Build marimo
        run: hatch build

      - name: ğŸ“¤ Upload to PyPI
        env:
          HATCH_INDEX_USER: ${{ secrets.PYPI_USER }}
          HATCH_INDEX_AUTH: ${{ secrets.PYPI_PASSWORD }}
        run: hatch publish

      - name: ğŸ”¨ Get version
        id: get_version
        run: |
          echo "marimo_version=$(hatch version)" >> $GITHUB_OUTPUT

      - name: ğŸ“¦ Update package.json version from CLI
        working-directory: frontend
        run: |
          echo "Updating package.json version to ${{ steps.get_version.outputs.marimo_version }}"
          npm version ${{ steps.get_version.outputs.marimo_version }} --no-git-tag-version

      - name: ğŸ“¦ Upload frontend artifact for npm publish
        uses: actions/upload-artifact@v6
        with:
          name: frontend
          path: frontend/
          retention-days: 1

      - name: ğŸ“¦ Update package.json name to @marimo-team/islands
        working-directory: frontend
        run: |
          sed -i 's/"name": "@marimo-team\/frontend"/"name": "@marimo-team\/islands"/' package.json

      - name: ğŸ“¦ Rebuild frontend for islands
        working-directory: frontend
        env:
          NODE_ENV: production
          VITE_MARIMO_ISLANDS: 'true'
          VITE_MARIMO_VERSION: ${{ steps.get_version.outputs.marimo_version }}
        run: |
          pnpm turbo build:islands
          ./islands/validate.sh

      - name: ğŸ“¦ Upload islands artifact for npm publish
        uses: actions/upload-artifact@v6
        with:
          name: frontend-islands
          path: frontend/
          retention-days: 1

  publish_wasm:
    name: ğŸ“¤ Publish @marimo-team/frontend to npm
    needs: publish_release
    uses: ./.github/workflows/publish-npm.yml
    with:
      package-artifact-name: frontend
      working-directory: '.'
    permissions:
      id-token: write  # Required for OIDC
      contents: read

  publish_islands:
    name: ğŸ“¤ Publish @marimo-team/islands to npm
    needs: publish_release
    uses: ./.github/workflows/publish-npm.yml
    with:
      package-artifact-name: frontend-islands
      working-directory: '.'
    permissions:
      id-token: write  # Required for OIDC
      contents: read

  publish_docker:
    name: ğŸ‹ Publish Docker images
    needs: publish_release
    uses: ./.github/workflows/publish-docker.yml
    with:
      marimo_version: ${{ needs.publish_release.outputs.marimo_version }}
    permissions:
      contents: read
      packages: write
