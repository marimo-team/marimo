name: Test BE

on:
  push:
    branches: [main]
  pull_request:

env:
  MARIMO_SKIP_UPDATE_CHECK: 1

jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      docs: ${{ steps.filter.outputs.docs }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            backend:
              - 'marimo/**'
              - 'tests/**'
              - 'pyproject.toml'
            docs:
              - 'docs/**'

  test_docs:
    needs: changes
    if: ${{ needs.changes.outputs.docs == 'true' }}
    name: Test docs
    runs-on: ubuntu-latest
    steps:
      - name: üõë Cancel Previous Runs
        uses: styfle/cancel-workflow-action@0.12.1

      - name: ‚¨áÔ∏è Checkout repo
        uses: actions/checkout@v4

      - name: ‚¨áÔ∏è Install Hatch
        uses: pypa/hatch@install

      - name: üìö Build docs
        run: hatch run docs:build --strict

  test_python:
    needs: changes
    if: ${{ needs.changes.outputs.backend == 'true' }}
    name: ${{ matrix.os }} / Py ${{ matrix.python-version }} / ${{ matrix.dependencies }} deps
    runs-on: ${{ matrix.os }}
    timeout-minutes: 20
    defaults:
      run:
        shell: bash

    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        dependencies: ["core", "core-optional"]
        python-version: ["3.9"]
        include:
          - os: ubuntu-latest
            python-version: "3.10"
            dependencies: "core"
          - os: ubuntu-latest
            python-version: "3.11"
            dependencies: "core"
          - os: ubuntu-latest
            python-version: "3.12"
            dependencies: "core"
          - os: ubuntu-latest
            python-version: "3.13"
            dependencies: "core"
          - os: ubuntu-latest
            python-version: "3.9"
            dependencies: "core-optional"
          - os: ubuntu-latest
            python-version: "3.10"
            dependencies: "core-optional"
          - os: ubuntu-latest
            python-version: "3.11"
            dependencies: "core-optional"
          - os: ubuntu-latest
            python-version: "3.12"
            dependencies: "core-optional"
          - os: ubuntu-latest
            python-version: "3.13"
            dependencies: "core-optional"
          - os: ubuntu-latest
            python-version: "3.9"
            dependencies: "minimal"
    steps:
      - name: üõë Cancel Previous Runs
        uses: styfle/cancel-workflow-action@0.12.1

      - uses: actions/checkout@v4

      - name: ü•ö Install Hatch
        uses: pypa/hatch@install

      # This step is needed since some of our tests rely on the index.html file
      - name: Create assets directory, copy over index.html
        run: |
          mkdir -p marimo/_static/assets
          cp frontend/index.html marimo/_static/index.html
          cp frontend/public/favicon.ico marimo/_static/favicon.ico

      # Cache testmon database for faster incremental testing
      - name: Cache testmon database
        uses: actions/cache@v4
        with:
          path: .testmondata
          key: testmon-${{ matrix.os }}-${{ matrix.python-version }}-${{ matrix.dependencies }}-${{ github.sha }}
          restore-keys: |
            testmon-${{ matrix.os }}-${{ matrix.python-version }}-${{ matrix.dependencies }}-
            testmon-${{ matrix.os }}-${{ matrix.python-version }}-
            testmon-${{ matrix.os }}-

      - name: Lint
        if: ${{ matrix.python-version == '3.12' }}
        run: hatch run lint

      - name: Typecheck
        if: ${{ matrix.python-version == '3.12' }}
        run: hatch run typecheck:check

      # Test with base dependencies (w/ testmon)
      - name: Test with base dependencies (that have changed)
        if: ${{ matrix.dependencies == 'core' }}
        run: |
          hatch run +py=${{ matrix.python-version }} test:test tests/ \
            -v \
            -k "not test_cli" \
            --durations=10 \
            --picked=first \
            --testmon

      # Test with optional dependencies (w/ testmon)
      - name: Test with optional dependencies (that have changed)
        if: ${{ matrix.dependencies == 'core-optional' && matrix.python-version != '3.13' }}
        run: |
          hatch run +py=${{ matrix.python-version }} test-optional:test tests/ \
            -v \
            -k "not test_cli" \
            --durations=10 \
            --picked=first \
            --testmon

      # Test with optional dependencies (no testmon)
      # We only do this for 3.13 since running all tests can be slow and only do it on one various
      - name: Test with optional dependencies (all)
        if: ${{ matrix.dependencies == 'core-optional' && matrix.python-version == '3.13' }}
        run: |
          hatch run +py=${{ matrix.python-version }} test-optional:test tests/ \
            -v \
            -k "not test_cli" \
            --durations=10 \
            --picked=first

      # Test with minimal dependencies using lowest resolution
      # https://docs.astral.sh/uv/concepts/resolution/#lowest-resolution
      # https://docs.astral.sh/uv/reference/environment/#uv_resolution
      - name: Test with minimal dependencies (lowest resolution)
        if: ${{ matrix.dependencies == 'minimal' }}
        run: |
          hatch run +py=${{ matrix.python-version }} test:test tests/ \
            -v \
            -k "not test_cli" \
            --durations=10 \
            --picked=first \
            --testmon
        env:
          UV_RESOLUTION: lowest

  # Only run coverage on `main` so it is not blocking
  test_coverage:
    needs: changes
    if: ${{ needs.changes.outputs.backend == 'true' && github.ref == 'refs/heads/main' && github.event_name == 'push' }}
    name: Test coverage
    runs-on: ubuntu-latest
    timeout-minutes: 25
    steps:
      - name: üõë Cancel Previous Runs
        uses: styfle/cancel-workflow-action@0.12.1

      - uses: actions/checkout@v4

      - name: ü•ö Install Hatch
        uses: pypa/hatch@install

      # This step is needed since some of our tests rely on the index.html file
      - name: Create assets directory, copy over index.html
        run: |
          mkdir -p marimo/_static/assets
          cp frontend/index.html marimo/_static/index.html
          cp frontend/public/favicon.ico marimo/_static/favicon.ico

      # Cache testmon database for faster incremental testing
      - name: Cache testmon database
        uses: actions/cache@v4
        with:
          path: .testmondata
          key: testmon-coverage-${{ github.sha }}
          restore-keys: |
            testmon-coverage-

      - name: Test with optional dependencies
        run: |
          hatch run +py=3.12 test-optional:test -v tests/ -k "not test_cli" --durations=10 \
          --cov=marimo --cov-report=xml --junitxml=junit.xml -o junit_family=legacy --testmon

      # Only upload coverage on `main` so it is not blocking
      # and only on `3.12`, `ubuntu-latest`, with optional deps since it is mostly duplicate
      # coverage from the other matrix jobs.
      - name: Upload coverage reports to Codecov
        if: ${{ !cancelled() }}
        uses: codecov/codecov-action@v5
        with:
          files: ./coverage.xml
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

      - name: Upload test results to Codecov
        if: ${{ !cancelled() }}
        uses: codecov/test-results-action@v1
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
